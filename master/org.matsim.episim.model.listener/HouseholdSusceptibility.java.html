<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HouseholdSusceptibility.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MATSim Episim</a> &gt; <a href="index.source.html" class="el_package">org.matsim.episim.model.listener</a> &gt; <span class="el_source">HouseholdSusceptibility.java</span></div><h1>HouseholdSusceptibility.java</h1><pre class="source lang-java linenums">package org.matsim.episim.model.listener;

import com.google.inject.Inject;
import it.unimi.dsi.fastutil.objects.Object2BooleanMap;
import it.unimi.dsi.fastutil.objects.Object2BooleanOpenHashMap;
import it.unimi.dsi.fastutil.objects.Object2DoubleMap;
import it.unimi.dsi.fastutil.objects.Object2DoubleOpenHashMap;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.matsim.api.core.v01.Id;
import org.matsim.api.core.v01.population.Person;
import org.matsim.core.utils.geometry.CoordinateTransformation;
import org.matsim.core.utils.geometry.transformations.IdentityTransformation;
import org.matsim.episim.EpisimPerson;
import org.matsim.episim.InfectionEventHandler;
import org.matsim.episim.analysis.DistrictLookup;
import org.matsim.episim.model.SimulationListener;
import org.matsim.facilities.ActivityFacility;
import org.matsim.vehicles.Vehicle;

import java.io.IOException;
import java.nio.file.Path;
import java.util.*;

public class HouseholdSusceptibility implements SimulationListener {

<span class="nc" id="L27">	private static final Logger log = LogManager.getLogger(HouseholdSusceptibility.class);</span>

	/**
	 * Susceptibility for each household.
	 */
<span class="nc" id="L32">	private final Object2DoubleMap&lt;String&gt; houseHoldSusceptibility = new Object2DoubleOpenHashMap&lt;&gt;();</span>

	/**
	 * Compliant status of households.
	 */
<span class="nc" id="L37">	private final Object2BooleanMap&lt;String&gt; nonCompliant = new Object2BooleanOpenHashMap&lt;&gt;();</span>

	private final Config config;

	@Inject
<span class="nc" id="L42">	public HouseholdSusceptibility(Config config) {</span>
<span class="nc" id="L43">		this.config = config;</span>
<span class="nc" id="L44">	}</span>

	@Override
	public void init(SplittableRandom rnd, Map&lt;Id&lt;Person&gt;, EpisimPerson&gt; persons, Map&lt;Id&lt;ActivityFacility&gt;, InfectionEventHandler.EpisimFacility&gt; facilities, Map&lt;Id&lt;Vehicle&gt;, InfectionEventHandler.EpisimVehicle&gt; vehicles) {

<span class="nc" id="L49">		DistrictLookup.Index index = null;</span>
<span class="nc bnc" id="L50" title="All 2 branches missed.">		if (config.shp != null) {</span>
<span class="nc" id="L51">			CoordinateTransformation ct = new IdentityTransformation();</span>
			try {
<span class="nc" id="L53">				index = new DistrictLookup.Index(config.shp.toFile(), ct, config.feature);</span>
<span class="nc" id="L54">			} catch (IOException e) {</span>
<span class="nc" id="L55">				log.error(&quot;Could not read shape file&quot;, e);</span>
<span class="nc" id="L56">			}</span>
		}

<span class="nc" id="L59">		int selected = 0;</span>

<span class="nc bnc" id="L61" title="All 2 branches missed.">		for (EpisimPerson p : persons.values()) {</span>

<span class="nc bnc" id="L63" title="All 2 branches missed.">			if (index != null) {</span>

<span class="nc" id="L65">				double homeX = (double) p.getAttributes().getAttribute(&quot;homeX&quot;);</span>
<span class="nc" id="L66">				double homeY = (double) p.getAttributes().getAttribute(&quot;homeY&quot;);</span>

				try {
<span class="nc" id="L69">					String result = index.query(homeX, homeY);</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">					if (!config.selection.contains(result))</span>
<span class="nc" id="L71">						continue;</span>

<span class="nc" id="L73">					selected++;</span>

<span class="nc" id="L75">				} catch (NoSuchElementException e) {</span>
<span class="nc" id="L76">					continue;</span>
<span class="nc" id="L77">				}</span>

			}

<span class="nc" id="L81">			String homeId = getHomeId(p);</span>

<span class="nc bnc" id="L83" title="All 2 branches missed.">			if (config.pHouseholds &gt; 0)</span>
<span class="nc" id="L84">				p.setSusceptibility(houseHoldSusceptibility.computeIfAbsent(homeId, (k) -&gt; sample(rnd)));</span>

<span class="nc bnc" id="L86" title="All 2 branches missed.">			if (config.pNonVaccinable &gt; 0) {</span>
<span class="nc bnc" id="L87" title="All 4 branches missed.">				if (nonCompliant.computeIfAbsent(homeId, (k) -&gt; rnd.nextDouble() &lt; config.pNonVaccinable)) {</span>
<span class="nc" id="L88">					p.setVaccinable(false);</span>
				}
			}
<span class="nc" id="L91">		}</span>

<span class="nc bnc" id="L93" title="All 2 branches missed.">		if (index != null)</span>
<span class="nc" id="L94">			log.info(&quot;Selected {} persons by shape file&quot;, selected);</span>
<span class="nc" id="L95">	}</span>

	/**
	 * Samples susceptibility for a household.
	 */
	private double sample(SplittableRandom rnd) {

<span class="nc bnc" id="L102" title="All 2 branches missed.">		if (rnd.nextDouble() &lt; config.pHouseholds)</span>
<span class="nc" id="L103">			return config.susceptibility;</span>

<span class="nc" id="L105">		return 1.0;</span>
	}

	private String getHomeId(EpisimPerson person) {
<span class="nc" id="L109">		String home = (String) person.getAttributes().getAttribute(&quot;homeId&quot;);</span>
		// fallback to person id if there is no home
<span class="nc bnc" id="L111" title="All 2 branches missed.">		return home != null ? home : person.getPersonId().toString();</span>
	}

	@Override
	public String toString() {
<span class="nc" id="L116">		return &quot;HouseholdSusceptibility{p=&quot; + config.pHouseholds + &quot;, susp=&quot; + config.susceptibility + &quot;}&quot;;</span>
	}

	public static Config newConfig() {
<span class="nc" id="L120">		return new Config();</span>
	}


	/**
	 * Holds config options for this class.
	 */
	public static final class Config {

<span class="nc" id="L129">		private double pHouseholds = 0;</span>
<span class="nc" id="L130">		private double pNonVaccinable = 0;</span>
<span class="nc" id="L131">		private double susceptibility = 5;</span>

		private Path shp;
		private String feature;
		private Set&lt;String&gt; selection;

<span class="nc" id="L137">		private Config() {</span>
<span class="nc" id="L138">		}</span>

		/**
		 * Modify the susceptibility of a certain percentage of households.
		 * @param pHouseholds percentage of households in (0, 1)
		 * @param susceptibility modified susceptibility
		 */
		public Config withSusceptibleHouseholds(double pHouseholds, double susceptibility) {
<span class="nc" id="L146">			this.pHouseholds = pHouseholds;</span>
<span class="nc" id="L147">			this.susceptibility = susceptibility;</span>
<span class="nc" id="L148">			return this;</span>
		}

		/**
		 * Set given percentage of households to be non-vaccinable.
		 */
		public Config withNonVaccinableHouseholds(double p) {
<span class="nc" id="L155">			this.pNonVaccinable = p;</span>
<span class="nc" id="L156">			return this;</span>
		}

		/**
		 * Filter by shape file.
		 */
		public Config withShape(Path shp) {
<span class="nc" id="L163">			this.shp = shp;</span>
<span class="nc" id="L164">			return this;</span>
		}

		/**
		 * Filter by {@code featureName} to be contained in {@code values}.
		 */
		public Config withFeature(String featureName, String... values) {
<span class="nc" id="L171">			this.feature = featureName;</span>
<span class="nc" id="L172">			this.selection = new HashSet&lt;&gt;();</span>
<span class="nc" id="L173">			this.selection.addAll(Arrays.asList(values));</span>
<span class="nc" id="L174">			return this;</span>
		}

	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>