<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReplayHandler.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MATSim Episim</a> &gt; <a href="index.source.html" class="el_package">org.matsim.episim</a> &gt; <span class="el_source">ReplayHandler.java</span></div><h1>ReplayHandler.java</h1><pre class="source lang-java linenums">/*-
 * #%L
 * MATSim Episim
 * %%
 * Copyright (C) 2020 matsim-org
 * %%
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 * #L%
 */
package org.matsim.episim;

import com.google.inject.Inject;
import org.apache.commons.lang3.NotImplementedException;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.matsim.api.core.v01.Coord;
import org.matsim.api.core.v01.Id;
import org.matsim.api.core.v01.Scenario;
import org.matsim.api.core.v01.events.*;
import org.matsim.api.core.v01.network.Link;
import org.matsim.core.api.experimental.events.EventsManager;
import org.matsim.core.api.internal.HasPersonId;
import org.matsim.core.events.EventsUtils;
import org.matsim.core.events.handler.BasicEventHandler;
import org.matsim.core.gbl.Gbl;
import org.matsim.core.router.TripStructureUtils;
import org.matsim.facilities.ActivityFacility;

import javax.annotation.Nullable;
import java.time.DayOfWeek;
import java.util.*;

/**
 * Handler that replays events from {@link EpisimConfigGroup#getInputEventsFile()} with corrected time and attributes.
 */
public final class ReplayHandler {

<span class="fc" id="L49">	private static final Logger log = LogManager.getLogger(ReplayHandler.class);</span>

	/**
	 * Needed in createEpisimFacilityId.
	 */
	private final EpisimConfigGroup episimConfig;

	private final Scenario scenario;
<span class="fc" id="L57">	private final Map&lt;DayOfWeek, List&lt;Event&gt;&gt; events = new EnumMap&lt;&gt;(DayOfWeek.class);</span>

	/**
	 * Constructor with optional scenario. Events will be read from given {@link EpisimConfigGroup#getInputEventsFiles()}.
	 */
	@Inject
<span class="fc" id="L63">	public ReplayHandler(EpisimConfigGroup config, @Nullable Scenario scenario) {</span>
<span class="fc" id="L64">		this.scenario = scenario;</span>
<span class="fc" id="L65">		this.episimConfig = config;</span>

<span class="fc" id="L67">		this.events.putAll(readEvents(episimConfig));</span>

<span class="pc bpc" id="L69" title="1 of 2 branches missed.">		if (events.size() != 7) {</span>
<span class="nc" id="L70">			EnumSet&lt;DayOfWeek&gt; missing = EnumSet.complementOf(EnumSet.copyOf(events.keySet()));</span>
<span class="nc" id="L71">			throw new IllegalStateException(&quot;Event definition missing for days: &quot; + missing);</span>
		}
<span class="fc" id="L73">	}</span>

	/**
	 * Constructor for using pre-defined events. A list of events for all weekdays needs to be present.
	 * Events also have to ordered by time.
	 *
	 * @param events ordered events for all weekdays
	 */
<span class="fc" id="L81">	public ReplayHandler(Map&lt;DayOfWeek, List&lt;Event&gt;&gt; events) {</span>
<span class="fc" id="L82">		this.events.putAll(events);</span>
<span class="fc" id="L83">		this.scenario = null;</span>
<span class="fc" id="L84">		this.episimConfig = null;</span>
<span class="fc" id="L85">	}</span>

	/**
	 * Replays event add modifies attributes based on current iteration.
	 */
	public void replayEvents(final InfectionEventHandler infectionHandler, DayOfWeek day) {
<span class="fc" id="L91">		infectionHandler.handleEvents(day, events.get(day));</span>
<span class="fc" id="L92">	}</span>

	/**
	 * All available events.
	 */
	public Map&lt;DayOfWeek, List&lt;Event&gt;&gt; getEvents() {
<span class="fc" id="L98">		return new EnumMap&lt;&gt;(events);</span>
	}

	/**
	 * Read events as defined in config.
	 */
	public Map&lt;DayOfWeek, List&lt;Event&gt;&gt; readEvents(EpisimConfigGroup config) {

<span class="fc" id="L106">		EnumMap&lt;DayOfWeek, List&lt;Event&gt;&gt; map = new EnumMap&lt;&gt;(DayOfWeek.class);</span>

<span class="fc bfc" id="L108" title="All 2 branches covered.">		for (EpisimConfigGroup.EventFileParams input : config.getInputEventsFiles()) {</span>

<span class="fc" id="L110">			List&lt;Event&gt; eventsForDay = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L111">			EventsManager manager = EventsUtils.createEventsManager();</span>
<span class="fc" id="L112">			manager.addHandler(new EventReader(eventsForDay));</span>
<span class="fc" id="L113">			EventsUtils.readEvents(manager, input.getPath());</span>
<span class="fc" id="L114">			manager.finishProcessing();</span>

<span class="fc" id="L116">			log.info(&quot;Read in {} events for {}, with time range {} - {}&quot;, eventsForDay.size(), input.getDays(), eventsForDay.get(0).getTime(),</span>
<span class="fc" id="L117">					eventsForDay.get(eventsForDay.size() - 1).getTime());</span>

<span class="fc bfc" id="L119" title="All 2 branches covered.">			for (DayOfWeek day : input.getDays()) {</span>
<span class="pc bpc" id="L120" title="1 of 2 branches missed.">				if (map.containsKey(day))</span>
<span class="nc" id="L121">					throw new IllegalStateException(&quot;Events for day &quot; + day + &quot; already defined!&quot;);</span>

<span class="fc" id="L123">				map.put(day, eventsForDay);</span>
<span class="fc" id="L124">			}</span>
<span class="fc" id="L125">		}</span>

<span class="fc" id="L127">		return map;</span>
	}

	/**
	 * Replaces all stored events
	 *
	 * @param events new events to store
	 */
	void setEvents(Map&lt;DayOfWeek, List&lt;Event&gt;&gt; events) {
<span class="fc" id="L136">		this.events.clear();</span>
<span class="fc" id="L137">		this.events.putAll(events);</span>
<span class="fc" id="L138">	}</span>

	/**
	 * Helper class to read events one time.
	 */
	private final class EventReader implements BasicEventHandler {

		private final List&lt;Event&gt; events;

<span class="fc" id="L147">		private EventReader(List&lt;Event&gt; events) {</span>
<span class="fc" id="L148">			this.events = events;</span>
<span class="fc" id="L149">		}</span>

		@Override
		public void handleEvent(Event event) {

			// Add coordinate information if not present
<span class="fc bfc" id="L155" title="All 2 branches covered.">			if (event instanceof ActivityStartEvent) {</span>
<span class="fc" id="L156">				ActivityStartEvent e = (ActivityStartEvent) event;</span>

<span class="fc bfc" id="L158" title="All 2 branches covered.">				if (!shouldHandleActivityEvent(e, e.getActType())) {</span>
<span class="fc" id="L159">					return;</span>
				}

<span class="fc" id="L162">				Coord coord = e.getCoord();</span>
<span class="pc bpc" id="L163" title="3 of 6 branches missed.">				if (coord == null &amp;&amp; scenario != null &amp;&amp; scenario.getNetwork().getLinks().containsKey(e.getLinkId())) {</span>
<span class="nc" id="L164">					Link link = scenario.getNetwork().getLinks().get(e.getLinkId());</span>
<span class="nc" id="L165">					coord = link.getToNode().getCoord();</span>
				}

<span class="fc" id="L168">				event = new ActivityStartEvent(e.getTime(), e.getPersonId(), e.getLinkId(),</span>
<span class="fc" id="L169">						createEpisimFacilityId(e),</span>
<span class="fc" id="L170">						e.getActType().intern(), coord);</span>
<span class="fc bfc" id="L171" title="All 2 branches covered.">			} else if (event instanceof ActivityEndEvent) {</span>
<span class="fc" id="L172">				ActivityEndEvent e = (ActivityEndEvent) event;</span>

<span class="fc bfc" id="L174" title="All 2 branches covered.">				if (!shouldHandleActivityEvent(e, e.getActType())) {</span>
<span class="fc" id="L175">					return;</span>
				}

<span class="fc" id="L178">				String actType = e.getActType().intern();</span>
<span class="fc" id="L179">				double time = e.getTime();</span>
<span class="fc" id="L180">				event = new ActivityEndEvent(time, e.getPersonId(), e.getLinkId(),</span>
<span class="fc" id="L181">						createEpisimFacilityId(e),</span>
						actType);
<span class="fc bfc" id="L183" title="All 2 branches covered.">			} else if (event instanceof PersonEntersVehicleEvent) {</span>
<span class="fc bfc" id="L184" title="All 2 branches covered.">				if (!shouldHandlePersonEvent((PersonEntersVehicleEvent) event)) {</span>
<span class="fc" id="L185">					return;</span>
				}
<span class="pc bpc" id="L187" title="1 of 2 branches missed.">			} else if (event instanceof PersonLeavesVehicleEvent) {</span>
<span class="fc bfc" id="L188" title="All 2 branches covered.">				if (!shouldHandlePersonEvent((PersonLeavesVehicleEvent) event)) {</span>
<span class="fc" id="L189">					return;</span>
				}
			}

<span class="fc" id="L193">			events.add(event);</span>
<span class="fc" id="L194">		}</span>


	}

	/**
	 * Whether {@code event} should be handled.
	 *
	 * @param actType activity type
	 */
	public static boolean shouldHandleActivityEvent(HasPersonId event, String actType) {
		// ignore drt and stage activities
<span class="pc bpc" id="L206" title="2 of 4 branches missed.">		return !event.getPersonId().toString().startsWith(&quot;drt&quot;) &amp;&amp; !event.getPersonId().toString().startsWith(&quot;rt&quot;)</span>
<span class="fc bfc" id="L207" title="All 2 branches covered.">				&amp;&amp; !TripStructureUtils.isStageActivityType(actType);</span>
	}

	/**
	 * Whether a Person event (e.g. {@link PersonEntersVehicleEvent} should be handled.
	 */
	public static boolean shouldHandlePersonEvent(HasPersonId event) {
		// ignore pt drivers and drt
<span class="fc" id="L215">		String id = event.getPersonId().toString();</span>
<span class="pc bpc" id="L216" title="3 of 8 branches missed.">		return !id.startsWith(&quot;pt_pt&quot;) &amp;&amp; !id.startsWith(&quot;pt_tr&quot;) &amp;&amp; !id.startsWith(&quot;drt&quot;) &amp;&amp; !id.startsWith(&quot;rt&quot;);</span>
	}

	private Id&lt;ActivityFacility&gt; createEpisimFacilityId(HasFacilityId event) {
<span class="fc bfc" id="L220" title="All 2 branches covered.">		if (episimConfig.getFacilitiesHandling() == EpisimConfigGroup.FacilitiesHandling.snz) {</span>
<span class="fc" id="L221">			Id&lt;ActivityFacility&gt; id = event.getFacilityId();</span>
<span class="pc bpc" id="L222" title="1 of 2 branches missed.">			if (id == null)</span>
<span class="nc" id="L223">				throw new IllegalStateException(&quot;No facility id present. Please switch to episimConfig.setFacilitiesHandling( EpisimConfigGroup.FacilitiesHandling.bln ) &quot;);</span>

<span class="fc" id="L225">			return id;</span>
<span class="pc bpc" id="L226" title="1 of 2 branches missed.">		} else if (episimConfig.getFacilitiesHandling() == EpisimConfigGroup.FacilitiesHandling.bln) {</span>
<span class="fc bfc" id="L227" title="All 2 branches covered.">			if (event instanceof ActivityStartEvent) {</span>
<span class="fc" id="L228">				ActivityStartEvent theEvent = (ActivityStartEvent) event;</span>
<span class="fc" id="L229">				return Id.create(theEvent.getActType().split(&quot;_&quot;)[0] + &quot;_&quot; + theEvent.getLinkId().toString(), ActivityFacility.class);</span>
<span class="pc bpc" id="L230" title="1 of 2 branches missed.">			} else if (event instanceof ActivityEndEvent) {</span>
<span class="fc" id="L231">				ActivityEndEvent theEvent = (ActivityEndEvent) event;</span>
<span class="fc" id="L232">				return Id.create(theEvent.getActType().split(&quot;_&quot;)[0] + &quot;_&quot; + theEvent.getLinkId().toString(), ActivityFacility.class);</span>
			} else {
<span class="nc" id="L234">				throw new IllegalStateException(&quot;unexpected event type=&quot; + ((Event) event).getEventType());</span>
			}
		} else {
<span class="nc" id="L237">			throw new NotImplementedException(Gbl.NOT_IMPLEMENTED);</span>
		}

	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>