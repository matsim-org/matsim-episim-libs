<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AbstractProgressionModel.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MATSim Episim</a> &gt; <a href="index.source.html" class="el_package">org.matsim.episim.model</a> &gt; <span class="el_source">AbstractProgressionModel.java</span></div><h1>AbstractProgressionModel.java</h1><pre class="source lang-java linenums">package org.matsim.episim.model;

import it.unimi.dsi.fastutil.objects.Object2LongMap;
import it.unimi.dsi.fastutil.objects.Object2LongOpenHashMap;
import org.matsim.api.core.v01.Id;
import org.matsim.api.core.v01.population.Person;
import org.matsim.episim.EpisimConfigGroup;
import org.matsim.episim.EpisimPerson;
import org.matsim.episim.EpisimReporting;
import org.matsim.episim.EpisimUtils;
import org.matsim.episim.model.progression.DiseaseStatusTransitionModel;

import javax.inject.Inject;
import java.io.Externalizable;
import java.io.IOException;
import java.io.ObjectInput;
import java.io.ObjectOutput;
import java.util.SplittableRandom;

/**
 * Abstract base implementation for a progression model that stores and updates state transitions.
 * It does *not* contain any decision logic when and to which state the disease will progress.
 */
abstract class AbstractProgressionModel implements ProgressionModel, Externalizable {

	protected final SplittableRandom rnd;
	protected final EpisimConfigGroup episimConfig;

	/**
	 * Stores the next state and after which day. (int &amp; int) = 64bit
	 */
<span class="fc" id="L32">	private final Object2LongMap&lt;Id&lt;Person&gt;&gt; nextStateAndDay = new Object2LongOpenHashMap&lt;&gt;();</span>
	private final DiseaseStatusTransitionModel statusTransitionModel;

	@Inject
<span class="fc" id="L36">	AbstractProgressionModel(SplittableRandom rnd, EpisimConfigGroup episimConfig, DiseaseStatusTransitionModel statusTransitionModel) {</span>
<span class="fc" id="L37">		this.rnd = rnd;</span>
<span class="fc" id="L38">		this.episimConfig = episimConfig;</span>
<span class="fc" id="L39">		this.statusTransitionModel = statusTransitionModel;</span>
<span class="fc" id="L40">	}</span>

	/**
	 * Stores two ints in one long value.
	 */
	private static long compoundLong(int x, int y) {
<span class="fc" id="L46">		return (((long) x) &lt;&lt; 32) | (y &amp; 0xffffffffL);</span>
	}

	@Override
	public void updateState(EpisimPerson person, int day) {

<span class="fc" id="L52">		EpisimPerson.DiseaseStatus status = person.getDiseaseStatus();</span>

		// No transitions from susceptible
<span class="fc bfc" id="L55" title="All 2 branches covered.">		if (status == EpisimPerson.DiseaseStatus.susceptible)</span>
<span class="fc" id="L56">			return;</span>

<span class="fc" id="L58">		double now = EpisimUtils.getCorrectedTime(episimConfig.getStartOffset(), 0, day);</span>
<span class="fc" id="L59">		Id&lt;Person&gt; id = person.getPersonId();</span>

<span class="fc bfc" id="L61" title="All 2 branches covered.">		if (status == EpisimPerson.DiseaseStatus.recovered) {</span>
			// one day after recovering person is released from quarantine
<span class="fc bfc" id="L63" title="All 2 branches covered.">			if (person.getQuarantineStatus() != EpisimPerson.QuarantineStatus.no)</span>
<span class="fc" id="L64">				person.setQuarantineStatus(EpisimPerson.QuarantineStatus.no, day);</span>

		}

		// 0 is empty transition
<span class="fc" id="L69">		long value = nextStateAndDay.getOrDefault(id, 0);</span>

<span class="fc bfc" id="L71" title="All 2 branches covered.">		if (value != 0) {</span>

			// reverse of compound long
<span class="fc" id="L74">			int transitionDay = (int) value;</span>
<span class="fc" id="L75">			int nextState = (int) (value &gt;&gt; 32);</span>

<span class="fc" id="L77">			int daysSince = person.daysSince(status, day);</span>
<span class="fc bfc" id="L78" title="All 2 branches covered.">			if (daysSince &gt;= transitionDay) {</span>
<span class="fc" id="L79">				EpisimPerson.DiseaseStatus next = EpisimPerson.DiseaseStatus.values()[nextState];</span>
<span class="fc" id="L80">				person.setDiseaseStatus(now, next);</span>
<span class="fc" id="L81">				onTransition(person, now, day, status, next);</span>

<span class="fc bfc" id="L83" title="All 2 branches covered.">				if (updateNext(person, id, next, day))</span>
<span class="fc" id="L84">					updateState(person, day);</span>

			}
<span class="fc" id="L87">		} else {</span>
<span class="fc bfc" id="L88" title="All 2 branches covered.">			if (updateNext(person, id, status, day))</span>
<span class="fc" id="L89">				updateState(person, day);</span>
		}
<span class="fc" id="L91">	}</span>

	/**
	 * Set next transition state and day for a person.
	 *
	 * @return true when there should be an immediate update again
	 */
	private boolean updateNext(EpisimPerson person, Id&lt;Person&gt; id, EpisimPerson.DiseaseStatus from, int day) {

		// clear transition
<span class="fc bfc" id="L101" title="All 2 branches covered.">		if (from == EpisimPerson.DiseaseStatus.susceptible) {</span>
<span class="fc" id="L102">			nextStateAndDay.removeLong(id);</span>
<span class="fc" id="L103">			return false;</span>
		}

<span class="fc" id="L106">		EpisimPerson.DiseaseStatus next = statusTransitionModel.decideNextState(person, person.getDiseaseStatus(), day);</span>
<span class="fc" id="L107">		int nextTransitionDay = decideTransitionDay(person, from, next);</span>

<span class="fc" id="L109">		nextStateAndDay.put(id, compoundLong(next.ordinal(), nextTransitionDay));</span>

		// allow multiple updates on the same day
<span class="fc bfc" id="L112" title="All 2 branches covered.">		return nextTransitionDay == 0;</span>
	}


	/**
	 * Chose how long a person stays in {@code from} until the disease changes to {@code to}.
	 */
	protected abstract int decideTransitionDay(EpisimPerson person, EpisimPerson.DiseaseStatus from, EpisimPerson.DiseaseStatus to);

	/**
	 * Arbitrary function that can be overwritten to perform actions on state transitions.
	 */
	protected void onTransition(EpisimPerson person, double now, int day, EpisimPerson.DiseaseStatus from, EpisimPerson.DiseaseStatus to) {
<span class="nc" id="L125">	}</span>

	@Override
	public EpisimPerson.DiseaseStatus getNextDiseaseStatus(Id&lt;Person&gt; personId) {
<span class="fc" id="L129">		long value = nextStateAndDay.getOrDefault(personId, 0);</span>
<span class="fc" id="L130">		int nextState = (int) (value &gt;&gt; 32);</span>
<span class="fc" id="L131">		return EpisimPerson.DiseaseStatus.values()[nextState];</span>
	}

	@Override
	public int getNextTransitionDays(Id&lt;Person&gt; personId) {
<span class="fc" id="L136">		long value = nextStateAndDay.getOrDefault(personId, 0);</span>
<span class="pc bpc" id="L137" title="1 of 2 branches missed.">		if (value == 0)</span>
<span class="nc" id="L138">			return -1;</span>

<span class="fc" id="L140">		return (int) value;</span>
	}

	@Override
	public boolean canProgress(EpisimReporting.InfectionReport report) {
<span class="fc bfc" id="L145" title="All 4 branches covered.">		return report.nTotalInfected &gt; 0 || report.nInQuarantineFull + report.nInQuarantineHome &gt; 0;</span>
	}

	@Override
	public void writeExternal(ObjectOutput out) throws IOException {
<span class="fc" id="L150">		out.writeInt(nextStateAndDay.size());</span>
<span class="fc bfc" id="L151" title="All 2 branches covered.">		for (Object2LongMap.Entry&lt;Id&lt;Person&gt;&gt; entry : nextStateAndDay.object2LongEntrySet()) {</span>
<span class="fc" id="L152">			EpisimUtils.writeChars(out, entry.getKey().toString());</span>
<span class="fc" id="L153">			out.writeLong(entry.getLongValue());</span>
<span class="fc" id="L154">		}</span>
<span class="fc" id="L155">	}</span>

	@Override
	public void readExternal(ObjectInput in) throws IOException {
<span class="fc" id="L159">		int n = in.readInt();</span>
<span class="fc bfc" id="L160" title="All 2 branches covered.">		for (int i = 0; i &lt; n; i++) {</span>
<span class="fc" id="L161">			Id&lt;Person&gt; key = Id.createPersonId(EpisimUtils.readChars(in));</span>
<span class="fc" id="L162">			nextStateAndDay.put(key, in.readLong());</span>
		}
<span class="fc" id="L164">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>